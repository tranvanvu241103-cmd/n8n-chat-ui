<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat UI - n8n</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl flex flex-col h-[80vh]">
      <!-- Header -->
      <div class="bg-blue-600 text-white text-center py-4 rounded-t-2xl font-bold text-lg">
        Trợ lý AI (kết nối n8n)
      </div>

      <!-- Chat box -->
      <div
        id="chatBox"
        class="flex-1 overflow-y-auto p-4 space-y-2 text-sm"
      >
        <div class="text-gray-500 text-center">Bắt đầu hội thoại...</div>
      </div>

      <!-- Input -->
      <div class="p-4 border-t flex space-x-2">
        <input
          id="userInput"
          type="text"
          placeholder="Nhập tin nhắn..."
          class="flex-1 border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        <button
          onclick="sendMessage()"
          class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700"
        >
          Gửi
        </button>
      </div>
    </div>

    <script>
      const chatBox = document.getElementById("chatBox");
      const userInput = document.getElementById("userInput");

      async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        // Hiển thị tin nhắn của user
        appendMessage("Bạn", message, "bg-blue-100 text-right");

        // Reset input
        userInput.value = "";

        try {
          // Gửi đến webhook n8n
          const res = await fetch(
            "https://dataanalystmrvu.tino.page/webhook/4da9af3e-7506-440d-bde0-618ea9c325f8",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text: message }),
            }
          );

          const data = await res.json();

          // Lấy trường trả về (tùy bạn set trong Respond node)
          const reply = data.answer || data.reply || JSON.stringify(data);

          appendMessage("Bot", reply, "bg-gray-200 text-left");
        } catch (err) {
          appendMessage(
            "Bot",
            "❌ Lỗi kết nối tới server n8n",
            "bg-red-100 text-left"
          );
        }
      }

      function appendMessage(sender, text, style) {
        const div = document.createElement("div");
        div.className = `p-2 rounded-lg max-w-[80%] ${style}`;
        div.innerHTML = `<strong>${sender}:</strong> ${text}`;
        div.style.wordBreak = "break-word";
        div.style.whiteSpace = "pre-wrap";
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      // Enter để gửi tin nhắn
      userInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          sendMessage();
        }
      });
    </script>
  </body>
</html>
